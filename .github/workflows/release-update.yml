on:
  release:
    types: [published, edited, released]
name: release-update
jobs:
    release-please:
     runs-on: ubuntu-latest
     steps:      
      - name: Trigger Repo Update
        uses: peter-evans/repository-dispatch@v2
        with:
          event-type: new-release
          
    build:
      name: Build
      runs-on: windows-latest
      steps:
        - uses: actions/checkout@v2

        - name: Set up .NET
          uses: actions/setup-dotnet@v1
          with:
             dotnet-version: 7.0.x
             
        - name: Restore Dependencies
          run: dotnet restore
          
        - name: Download Dalamud
          run: |
            Invoke-WebRequest -Uri https://goatcorp.github.io/dalamud-distrib/latest.zip -OutFile latest.zip
            Expand-Archive -Force latest.zip "$env:AppData\XIVLauncher\addon\Hooks\dev"
                      
        - name: publish on version change
          id: publish_nuget
          uses: alirezanet/publish-nuget@v3.0.4
          with:
            PROJECT_FILE_PATH: RotationSolver.Basic/RotationSolver.Basic.csproj
            VERSION_FILE_PATH: Directory.Build.props
            NUGET_KEY: ${{secrets.nuget_api_key}}

        - name: Build Plugin
          run: |
           invoke-expression 'dotnet build --no-restore --configuration Release RotationSolver'
           
        - name: Upload Artifact
          uses: actions/upload-artifact@v3
          with:
            path: .\RotationSolver\bin\Release\RotationSolver\
            
    release:
        name: release
        needs: build
        if: success() && startsWith(github.ref, 'refs/tags/v')
        runs-on: ubuntu-latest

        steps:
          - uses: actions/checkout@v3

          - name: Download Build Artifact
            uses: actions/download-artifact@v3

          - name: Get release
            id: get_release
            uses: bruceadams/get-release@v1.3.2
            env:
              GITHUB_TOKEN: ${{ github.token }}

          - name: Upload Release Asset
            uses: actions/upload-release-asset@v1
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
            with:
              upload_url: ${{ steps.get_release.outputs.upload_url }}
              asset_path: artifact/latest.zip
              asset_name: latest.zip
              asset_content_type: application/zip
